image: dcr.danawa.io/alpine-k8s-java:8

stages:
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository

before_script:
  - mkdir -p /root/.m2/repository
  - ln -s /root/.m2 .m2
  - export IMAGE="${REGISTRY}/${CI_PROJECT_TITLE}:latest"
  - echo "${IMAGE}"

build:
  stage: build
  script:
    - sh mvnw package -DskipTests
    - docker build -t ${IMAGE} .
    - docker push ${IMAGE}

deploy:
  stage: deploy
  cache: {}
  script:
    - kubectl patch deployment fastcatx-server -n fastcatx -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"date\":\"`date +'%s'`\"}},\"spec\":{\"containers\":[{\"name\":\"fastcatx-server\",\"image\":\"${IMAGE}\"}]}}}}"
    - sleep 5
    - kubectl get pod -n fastcatx -o wide
